<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2PAY Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f6f9; }
    .navbar {
      background-color: #1d2b64; color: white; padding: 16px 24px;
      font-size: 20px; font-weight: bold;
      display: flex; justify-content: space-between; align-items: center;
    }
    .balance-card, .section {
      background: white; width: 90%; margin: 20px auto;
      padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .balance { font-size: 28px; font-weight: bold; color: #2d8cff; }
    .actions { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
    .actions button {
      padding: 10px 20px; border: none; border-radius: 6px;
      background-color: #2d8cff; color: white; cursor: pointer;
    }
    .filter-select {
      display: block; width: 90%; margin: 10px auto;
      padding: 10px; font-size: 16px;
    }
    .request-card {
      background: #fff; margin-top: 10px; padding: 15px;
      border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .telegram-link {
      text-align: center; margin-top: 40px;
    }
    .telegram-link a {
      color: #2d8cff; text-decoration: none; font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="navbar">
    2PAY
    <span id="user-email">Loading...</span>
  </div>

  <div class="balance-card">
    <h2>Available Balance</h2>
    <div class="balance" id="balance">$0.00</div>
    <div class="actions">
      <button onclick="sendTo2Pay()">Send to 2PAY</button>
      <button onclick="alert('Feature not available now')">Deposit</button>
      <button onclick="location.href='withdraw.html'">Withdraw</button>
    </div>
  </div>

  <select class="filter-select" onchange="changeView(this.value)">
    <option value="withdraw">Withdrawal Requests</option>
    <option value="deposit">Deposit Requests</option>
    <option value="chats">Ongoing Chats</option>
  </select>

  <div class="section">
    <div id="contentList"></div>
  </div>

  <div class="telegram-link">
    <p>Join our <a href="https://t.me/official2pay" target="_blank">TELEGRAM CHANNEL</a></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDvFDByPPo9zgwKLdPaREz1OVMQCXmPfrs",
      authDomain: "bets-d795d.firebaseapp.com",
      databaseURL: "https://bets-d795d-default-rtdb.firebaseio.com",
      projectId: "bets-d795d",
      storageBucket: "bets-d795d.appspot.com",
      messagingSenderId: "384386108287",
      appId: "1:384386108287:android:d238a5ec8068d9bb9be84a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let currentUser;
    let currentView = "withdraw";

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "index.html";
      currentUser = user;
      document.getElementById("user-email").textContent = user.email;
      loadBalance();
      loadContent();
    });

    function loadBalance() {
      db.ref("users/" + currentUser.uid + "/balance").on("value", snap => {
        const bal = snap.val() || 0;
        document.getElementById("balance").textContent = "$" + parseFloat(bal).toFixed(2);
      });
    }

    function changeView(view) {
      currentView = view;
      loadContent();
    }

    function loadContent() {
      const container = document.getElementById("contentList");
      container.innerHTML = "";

      if (currentView === "withdraw") {
        db.ref("withdrawals").once("value", snap => {
          snap.forEach(child => {
            const data = child.val();
            const key = child.key;
            if (data.status === "pending" && data.uid !== currentUser.uid) {
              const earn = (data.amount * 1.2).toFixed(2);
              const div = document.createElement("div");
              div.className = "request-card";
              div.innerHTML = `
                <h4>Amount: $${data.amount}</h4>
                <p><b>You will earn:</b> $${earn}</p>
                <p>Email: ${data.email || 'N/A'}</p>
                <p>Bank: ${data.bankName || 'N/A'}</p>
                <p>Account: ${data.accountNumber || 'N/A'}</p>
                <p>Country: ${data.country || 'N/A'}</p>
                <p>${new Date(data.timestamp).toLocaleString()}</p>
                <button onclick="acceptRequest('${key}')">Accept</button>
              `;
              container.appendChild(div);
            }
          });
        });
      }

      else if (currentView === "deposit") {
        const placeholder = document.createElement("div");
        placeholder.className = "request-card";
        placeholder.innerHTML = "<p>Deposit requests coming soon...</p>";
        container.appendChild(placeholder);
      }

      else if (currentView === "chats") {
        db.ref("withdrawals").once("value", snap => {
          snap.forEach(child => {
            const data = child.val();
            if (data.status === "accepted" &&
               (data.uid === currentUser.uid || data.acceptedBy === currentUser.uid)) {
              const div = document.createElement("div");
              div.className = "request-card";
              div.innerHTML = `
                <h4>Ongoing Chat</h4>
                <p>Amount: $${data.amount}</p>
                <button onclick="goToChat('${data.chatId}')">Chat Now</button>
              `;
              container.appendChild(div);
            }
          });
        });
      }
    }

    function acceptRequest(key) {
      const ref = db.ref("withdrawals/" + key);
      ref.once("value", snap => {
        const data = snap.val();
        if (data.status !== "pending") return alert("Already accepted.");
        const chatId = "chat_" + Date.now();
        ref.update({ status: "accepted", acceptedBy: currentUser.uid, chatId });
        window.location.href = `chat.html?id=${chatId}`;
      });
    }

    function goToChat(chatId) {
      window.location.href = `chat.html?id=${chatId}`;
    }

    async function sendTo2Pay() {
      const receiverEmail = prompt("Enter receiver's email:");
      const amountStr = prompt("Enter amount to send:");
      const amount = parseFloat(amountStr);

      if (!receiverEmail || isNaN(amount) || amount <= 0) {
        return alert("Please enter valid inputs.");
      }

      if (receiverEmail === currentUser.email) {
        return alert("You cannot send money to yourself.");
      }

      const receiverSnap = await db.ref("users").orderByChild("email").equalTo(receiverEmail).once("value");
      if (!receiverSnap.exists()) return alert("Receiver not found");

      const receiverUid = Object.keys(receiverSnap.val())[0];
      const senderRef = db.ref("users/" + currentUser.uid + "/balance");
      const senderSnap = await senderRef.once("value");
      const senderBal = senderSnap.val() || 0;

      if (senderBal < amount) return alert("Insufficient balance");

      const receiverRef = db.ref("users/" + receiverUid + "/balance");

      await senderRef.set(senderBal - amount);
      await receiverRef.transaction(bal => (bal || 0) + amount);

      alert("Sent successfully to " + receiverEmail);
    }
  </script>
</body>
</html>